---
ingress:
  enabled: true
  tls: true
  hostname: ""
  httpBasicAuth: ""
  services:
    - serviceName: fluentd
      servicePort: 9880
      path: /fluentd
    - serviceName: opensearch-dashboards
      servicePort: 5601
      path: /opensearch-dashboards


opensearch-dashboards:
  image: "rubemlrm/opensearch-dashboards-no-security"
  opensearchHosts: "http://opensearch-cluster-master:9200"
  rbac:
    create: false
  config:
    opensearch_dashboards.yml:
      server:
        name: opensearch-dashboards
        basePath: "/opensearch-dashboards"
        rewriteBasePath: true
        ssl:
          enabled: false
          certificate: ""
          key: ""
      opensearch:
        ssl:
          verificationMode: none
  readinessProbe: {}

opensearch:
  replicas: 1
  minimumMasterNodes: 1
  networkPolicy:
    create: false
  podSecurityPolicy:
    create: false
    spec:
      privileged: true
  persistence:
    enabled: true
    # Set to false to disable the `fsgroup-volume` initContainer that will update permissions on the persistent disk.
    enableInitChown: false
  resources:
    requests:
      cpu: "250m"
      memory: "100Mi"
    limits:
      cpu: "400m"
      memory: "1Gi"
  config:
    opensearch.yml: |
      plugins.security.disabled: true
  lifecycle:
    postStart:
      exec:
        command:
          - bash
          - -c
          - |
            #!/bin/bash
            # Add a template to adjust number of shards/replicas1
            TEMPLATE_NAME=cmy_logging
            INDEX_PATTERN="*"
            SHARD_COUNT=1
            REPLICA_COUNT=0
            ES_URL=http://localhost:9200
            while [[ "$(curl -s -o /dev/null -w '%{http_code}\n' $ES_URL)" != "200" ]]; do sleep 1; done
            curl -XPUT "$ES_URL/_template/$TEMPLATE_NAME" -H 'Content-Type: application/json' -d'{"index_patterns":['\""$INDEX_PATTERN"\"'],"settings":{"number_of_shards":'$SHARD_COUNT',"number_of_replicas":'$REPLICA_COUNT'}}'
fluentd:
  kind: "Deployment"
  rbac:
    create: false
  podSecurityPolicy:
    enabled: false
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  service:
    type: "ClusterIP"
    annotations: {}
    ports:
      - name: "forwarder"
        protocol: TCP
        containerPort: 24224
      - name: "loginput"
        protocol: TCP
        containerPort: 9880
      - name: "probeport"
        protocol: TCP
        containerPort: 9881
  dashboards:
    enabled: false
  autoscaling:
    enabled: false
  metrics:
    serviceMonitor:
      enabled: false
  livenessProbe:
    httpGet:
      path: /metrics
      port: metrics
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 2
  readinessProbe:
    httpGet:
      path: /metrics
      port: metrics
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 2
  securityContext:
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 1000
  volumes:
    - name: etcfluentd-main
      configMap:
        name: fluentd-main
        defaultMode: 0777
    - name: etcfluentd-config
      configMap:
        name: fluentd-config
        defaultMode: 0777
  volumeMounts:
    - name: etcfluentd-main
      mountPath: /etc/fluent
    - name: etcfluentd-config
      mountPath: /etc/fluent/config.d/
  fileConfigs:
    01_sources.conf: |-
      <source>
        @type http
        port 9880
        bind 0.0.0.0
        body_size_limit 32m
        keepalive_timeout 10s
        @label @ELASTIC_INPUT
      </source>
      <source>
        @type http
        port 9881
        bind 0.0.0.0
      </source>
    02_filters.conf: |-
      <label @ELASTIC_INPUT>
        <match **>
          @type relabel
          @label @ELASTIC_DISPATCH
        </match>
      </label>
    03_dispatch.conf: |-
      <label @ELASTIC_DISPATCH>
        <match **>
          @type relabel
          @label @ELASTIC_OUTPUT
        </match>
      </label>

    04_outputs.conf: |-
      <label @ELASTIC_OUTPUT>
        <match **>
          @type elasticsearch
          #scheme http
          host "opensearch-cluster-master"
          port 9200
          @log_level debug
          index_name fluentd-${tag}-%Y.%m.%d
          <buffer tag, time>
            timekey 1h # chunks per hours ("3600" also available)
          </buffer>
          #user logstash
          #password logstash
          #ssl_verify false
          #ssl_version TLSv1_2
          logstash_format false
          enable_ilm true
          flush_interval 10s
        </match>
      </label>
